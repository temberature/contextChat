<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Web Summary</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
      }
    </style>
  </head>
  <body>
    <h1>Web Summary</h1>
    <p>Press the number keys to trigger the corresponding commands:</p>
    <button id="command1" data-key="1">1. Command 1</button>
    <button id="command2" data-key="2">2. Command 2</button>
    <button id="command3" data-key="3">3. Command 3</button>
    <button id="summaryButton" data-key="4">4. Get summary</button>
    <div id="loading" style="display: none">
      <p>Loading...</p>
    </div>

    <div id="result"></div>

    <script>
      const { ipcRenderer } = require("electron");
      const { SSE } = require("sse.js");
      const summaryButton = document.getElementById("summaryButton");
      summaryButton.addEventListener("click", () => {
        setLoading(true);
        ipcRenderer.send("get-summary");
      });

      ipcRenderer.on("summary-result", (event, markdownResult) => {
        setLoading(false);
        document.getElementById("result").innerText = markdownResult;
      });

      ipcRenderer.on("markdown-excerpt", async (event, markdownExcerpt) => {
        const prompt = markdownExcerpt + "总结一下上述内容：";
        const response = await getCompletionStream(
          prompt,
          "gpt-3.5-turbo",
          (chunk) => {
            setLoading(false);
            document.getElementById("result").innerText = chunk;
          }
        );

        // Handle the response as needed, e.g., display it in the web page
      });
      // Add more event listeners for the other command buttons here.
      // Example: document.getElementById('command1').addEventListener('click', yourFunctionForCommand1);

      // Add a keydown event listener to the window
      window.addEventListener("keydown", (event) => {
        const keyPressed = event.key;
        const buttonList = document.querySelectorAll("button");

        buttonList.forEach((button) => {
          const buttonKey = button.getAttribute("data-key");
          if (keyPressed === buttonKey) {
            button.click();
          }
        });
      });

      function setLoading(loading) {
        const loadingElement = document.getElementById("loading");
        if (loading) {
          loadingElement.style.display = "block";
        } else {
          loadingElement.style.display = "none";
        }
      }

      async function getCompletion(prompt, model = "gpt-3.5-turbo") {
        const requestBody = {
          model: model,
          messages: [{ role: "user", content: prompt }],
          temperature: 0,
        };

        const response = await fetch(
          "https://api.openai.com/v1/chat/completions",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ***REMOVED***`,
            },
            body: JSON.stringify(requestBody),
          }
        );

        const data = await response.json();
        return data.choices[0].message.content;
      }
      async function getCompletionStream(
        prompt,
        model = "gpt-3.5-turbo",
        callback
      ) {
        const requestBody = {
          model: model,
          messages: [{ role: "user", content: prompt }],
          temperature: 0,
          stream: true,
        };

        const source = new SSE(`https://api.openai.com/v1/chat/completions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ***REMOVED***`,
          },
          payload: JSON.stringify(requestBody),
        });
        let first = true,
          chunk;
        source.addEventListener("error", (e) => {
          console.log(e);
          const data = JSON.parse(e.data || "{}");
          if (data.error) {
            console.log(data.error);
            let confirmation;
            if (data.error.code === "context_length_exceeded") {
              alert(`${JSON.stringify(data.error)}`);
            } else {
              confirmation = window.confirm(
                `${JSON.stringify(data.error)}\n\nWould you like to try again?`
              );
            }
          }
        });
        source.addEventListener("message", function (e) {
          // Assuming we receive JSON-encoded data payloads:
          console.log(e.data);
          if (e.data !== "[DONE]") {
            var data = JSON.parse(e.data);
            // console.log(data);

            if (!data.choices[0].delta.content) {
              return;
            }
            if (first) {
              chunk = data.choices[0].delta.content;
              first = false;
            } else {
              chunk += data.choices[0].delta.content;
            }
            callback(chunk);
          }
        });
        source.stream();
      }
    </script>
  </body>
</html>
